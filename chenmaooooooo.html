<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸¡å…¬ç…²åˆ¶ä½œ 3D ç²’å­ç‰¹æ•ˆï¼ˆGIF å¯¼å‡ºç‰ˆï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
        }

        body {
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #ffccd5, #f7c8e0, #d4b5ff);
            background-size: 400% 400%;
            animation: bgFlow 15s ease infinite;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: background 1.5s ease;
        }

        @keyframes bgFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* è¾“å…¥æ¡†æŒ‰é’®ç»„ - æ–°å¢å¯¼å‡ºæŒ‰é’® */
        .input-group {
            position: absolute;
            top: 80px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10;
            width: 70%;
            max-width: 600px;
        }

        #textInput {
            flex: 1;
            height: 55px;
            padding: 0 20px;
            border: none;
            border-radius: 28px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            color: #d63384;
            font-size: 18px;
            outline: none;
            box-shadow: 0 4px 15px rgba(214, 51, 132, 0.1);
            transition: all 0.3s ease;
        }

        #textInput::placeholder {
            color: rgba(214, 51, 132, 0.5);
        }

        #textInput:focus {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 2px rgba(214, 51, 132, 0.3);
        }

        .btn {
            height: 55px;
            padding: 0 25px;
            border: none;
            border-radius: 28px;
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #generateBtn {
            background: linear-gradient(90deg, #d63384, #ff69b4);
            box-shadow: 0 4px 15px rgba(214, 51, 132, 0.2);
        }

        #exportBtn {
            background: linear-gradient(90deg, #ff8fab, #ff69b4);
            box-shadow: 0 4px 15px rgba(255, 138, 171, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(214, 51, 132, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* 3Dèˆå° - é€è§†æ•ˆæœ */
        .stage {
            perspective: 1200px;
            position: relative;
            margin-top: 50px;
        }

        .text-rotate {
            font-size: 100px;
            font-weight: 900;
            color: #d63384;
            text-shadow: 0 0 10px rgba(214, 51, 132, 0.3), 0 0 20px rgba(214, 51, 132, 0.1);
            transform-style: preserve-3d;
            animation: text3DRotate 8s linear infinite;
            position: relative;
            z-index: 2;
            white-space: nowrap;
        }

        @keyframes text3DRotate {
            0% { transform: rotateY(0deg) rotateX(0deg); }
            50% { transform: rotateY(180deg) rotateX(5deg); }
            100% { transform: rotateY(360deg) rotateX(0deg); }
        }

        .particle-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 1;
            pointer-events: none;
        }

        .heart-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #ff69b4;
            transform: rotate(45deg);
            box-shadow: 0 0 8px #ff69b4;
            opacity: 0.9;
            border-radius: 2px;
            animation: particleJump 2s ease-in-out infinite, particleRotate 3s linear infinite;
        }

        .heart-particle::before,
        .heart-particle::after {
            content: "";
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #ff69b4;
            border-radius: 50%;
            box-shadow: 0 0 8px #ff69b4;
        }

        .heart-particle::before { top: -4px; left: 0; }
        .heart-particle::after { top: 0; left: -4px; }

        .heart-particle.tiny {
            width: 5px;
            height: 5px;
            animation-duration: 1.5s, 2.5s;
        }
        .heart-particle.tiny::before,
        .heart-particle.tiny::after {
            width: 5px;
            height: 5px;
        }
        .heart-particle.tiny::before { top: -2.5px; }
        .heart-particle.tiny::after { left: -2.5px; }

        @keyframes particleJump {
            0%, 100% { transform: rotate(45deg) translateY(0px) scale(1); }
            50% { transform: rotate(45deg) translateY(-15px) scale(1.3); opacity: 1; }
        }

        @keyframes particleRotate {
            0% { transform: rotate(45deg) rotateZ(0deg); }
            100% { transform: rotate(45deg) rotateZ(360deg); }
        }

        .heart-particle.reverse {
            animation: particleJump 2s ease-in-out infinite, particleRotate 3s linear infinite reverse;
        }

        .tip-text {
            position: absolute;
            bottom: 50px;
            color: #d63384;
            opacity: 0.7;
            font-size: 16px;
            text-align: center;
        }

        /* GIFå¯¼å‡ºåŠ è½½æç¤º */
        .loading-tip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.9);
            color: #d63384;
            border-radius: 12px;
            font-size: 18px;
            z-index: 999;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body id="appBody">
    <div class="input-group">
        <input type="text" id="textInput" placeholder="è¯·è¾“å…¥æ–‡å­—ï¼ˆå¦‚ï¼šé¸¡å…¬ç…²åˆ¶ä½œï¼‰" maxlength="8" value="é¸¡å…¬ç…²åˆ¶ä½œ">
        <button id="generateBtn" class="btn">ç”Ÿæˆç‰¹æ•ˆ â¤ï¸</button>
        <button id="exportBtn" class="btn">å¯¼å‡º GIF ğŸï¸</button>
    </div>

    <div class="stage" id="captureStage">
        <div class="text-rotate" id="displayText">é¸¡å…¬ç…²åˆ¶ä½œ</div>
        <div class="particle-container" id="particleContainer"></div>
    </div>

    <div class="tip-text">é¸¡å…¬ç…²åˆ¶ä½œ | ç²’å­ç´§è´´æ–‡å­—è·³è·ƒæ—‹è½¬ | æ”¯æŒå¯¼å‡º1:1 GIF</div>
    <div class="loading-tip" id="loadingTip">æ­£åœ¨ç”ŸæˆGIFï¼Œè¯·ç¨å€™...</div>

    <!-- å¼•å…¥GIFå¯¼å‡ºåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ffmpeg.js@4.2.9003/dist/ffmpeg.min.js"></script>

    <script>
        // DOMå…ƒç´ è·å–
        const appBody = document.getElementById('appBody');
        const textInput = document.getElementById('textInput');
        const generateBtn = document.getElementById('generateBtn');
        const exportBtn = document.getElementById('exportBtn');
        const displayText = document.getElementById('displayText');
        const particleContainer = document.getElementById('particleContainer');
        const captureStage = document.getElementById('captureStage');
        const loadingTip = document.getElementById('loadingTip');

        // çˆ±æƒ…ä¸»é¢˜èƒŒæ™¯é¢„è®¾ï¼ˆç²‰ç³»æ¸å˜ï¼Œæ— è¯¡å¼‚é¢œè‰²ï¼‰
        const loveBgPresets = [
            "linear-gradient(135deg, #ffccd5, #f7c8e0, #d4b5ff)",
            "linear-gradient(135deg, #ffe5ec, #ffc2d1, #ff8fab)",
            "linear-gradient(135deg, #fff0f5, #fde2e4, #fad2e1)",
            "linear-gradient(135deg, #ffebf0, #ffd6e0, #ffc2f0)",
            "linear-gradient(135deg, #ffe8f0, #ffc8dd, #ffb3e6)"
        ];

        // å¯¹åº”èƒŒæ™¯çš„ç²’å­é¢œè‰²ï¼ˆåŒæ­¥åŒ¹é…ï¼Œä¿æŒçˆ±æƒ…ä¸»é¢˜è‰²è°ƒç»Ÿä¸€ï¼‰
        const bgMatchParticleColors = [
            ["#ff69b4", "#d4b5ff"],
            ["#ff8fab", "#ffc2d1"],
            ["#fad2e1", "#fde2e4"],
            ["#ffc2f0", "#ffd6e0"],
            ["#ffb3e6", "#ffc8dd"]
        ];

        // å…¨å±€å‚æ•°å­˜å‚¨
        let currentParams = {};

        // åŸºäºæ–‡å­—ç”Ÿæˆéšæœºå‚æ•°
        function getRandomParamsByText(text) {
            let seed = 1;
            for (let i = 0; i < text.length; i++) {
                seed = (seed * text.charCodeAt(i)) % 999999;
            }
            const random = (min, max) => {
                seed = (seed * 9301 + 49297) % 233280;
                return Math.floor(min + (seed / 233280) * (max - min));
            };

            const bgIndex = random(0, loveBgPresets.length - 1);
            return {
                rotateDuration: random(6, 10),
                particleCount: random(15, 30),
                jumpDuration: random(15, 25)/10,
                rotateDuration: random(25, 40)/10,
                bgIndex: bgIndex,
                colorIndex: random(0, bgMatchParticleColors[bgIndex].length - 1)
            };
        }

        // æ¸…é™¤ç²’å­
        function clearParticles() {
            particleContainer.innerHTML = '';
        }

        // ç”Ÿæˆç²’å­ï¼šé¢œè‰²éšèƒŒæ™¯åŒæ­¥å˜åŒ–
        function createHeartParticles(params) {
            clearParticles();
            const { particleCount, jumpDuration, rotateDuration, bgIndex, colorIndex } = params;
            const textRect = displayText.getBoundingClientRect();
            // ç²’å­é¢œè‰²åŒ¹é…å½“å‰èƒŒæ™¯
            const particleColor = bgMatchParticleColors[bgIndex][colorIndex];

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'heart-particle';
                if (Math.random() < 0.4) particle.classList.add('tiny');
                if (Math.random() < 0.5) particle.classList.add('reverse');

                const randomX = Math.random() * textRect.width - textRect.width/2;
                const randomY = Math.random() * textRect.height - textRect.height/2;
                particle.style.left = `calc(50% + ${randomX}px)`;
                particle.style.top = `calc(50% + ${randomY}px)`;

                // è®¾ç½®ç²’å­é¢œè‰²
                particle.style.backgroundColor = particleColor;
                particle.style.boxShadow = `0 0 8px ${particleColor}`;
                const style = document.createElement('style');
                style.textContent = `
                    #particleContainer .heart-particle:nth-child(${i+1})::before,
                    #particleContainer .heart-particle:nth-child(${i+1})::after {
                        background-color: ${particleColor};
                        box-shadow: 0 0 8px ${particleColor};
                    }
                `;
                document.head.appendChild(style);

                const delay = Math.random() * jumpDuration;
                particle.style.animationDuration = `${jumpDuration}s, ${rotateDuration}s`;
                particle.style.animationDelay = `${delay}s, ${delay}s`;

                particleContainer.appendChild(particle);
            }

            let particleTimer = setInterval(() => {
                if (particleContainer.children.length > particleCount + 10) {
                    clearInterval(particleTimer);
                    return;
                }
                const particle = document.createElement('div');
                particle.className = 'heart-particle tiny';
                if (Math.random() < 0.5) particle.classList.add('reverse');

                const randomX = Math.random() * textRect.width - textRect.width/2;
                const randomY = Math.random() * textRect.height - textRect.height/2;
                particle.style.left = `calc(50% + ${randomX}px)`;
                particle.style.top = `calc(50% + ${randomY}px)`;

                particle.style.backgroundColor = particleColor;
                particle.style.boxShadow = `0 0 8px ${particleColor}`;
                particle.style.animationDuration = `${jumpDuration}s, ${rotateDuration}s`;
                particle.style.animationDelay = `${Math.random() * jumpDuration}s`;

                particleContainer.appendChild(particle);
            }, 800);
        }

        // ç”Ÿæˆç‰¹æ•ˆï¼šèƒŒæ™¯éšæœº+ç²’å­é¢œè‰²åŒæ­¥
        function generateTextEffect(text) {
            if (!text.trim()) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆæ–‡å­—ï¼');
                return;
            }
            displayText.textContent = text;
            currentParams = getRandomParamsByText(text);
            // éšæœºåˆ‡æ¢çˆ±æƒ…ä¸»é¢˜èƒŒæ™¯
            appBody.style.background = loveBgPresets[currentParams.bgIndex];
            // æ–‡å­—é¢œè‰²åŒ¹é…èƒŒæ™¯
            const textColor = bgMatchParticleColors[currentParams.bgIndex][0];
            displayText.style.color = textColor;
            displayText.style.textShadow = `0 0 10px rgba(${hexToRgb(textColor).join(',')}, 0.3), 0 0 20px rgba(${hexToRgb(textColor).join(',')}, 0.1)`;
            // è®¾ç½®æ–‡å­—æ—‹è½¬
            displayText.style.animation = `text3DRotate ${currentParams.rotateDuration}s linear infinite`;
            createHeartParticles(currentParams);
        }

        // è¾…åŠ©å‡½æ•°ï¼šåå…­è¿›åˆ¶è½¬RGB
        function hexToRgb(hex) {
            hex = hex.replace('#', '');
            return [
                parseInt(hex.substring(0, 2), 16),
                parseInt(hex.substring(2, 4), 16),
                parseInt(hex.substring(4, 6), 16)
            ];
        }

        // æ ¸å¿ƒåŠŸèƒ½ï¼šå¯¼å‡º1:1 GIFï¼ˆæ–‡å­—æ—‹è½¬ä¸€åœˆï¼‰
        async function exportToGif() {
            const rotateDuration = currentParams.rotateDuration || 8;
            const frameCount = 30; // æ€»å¸§æ•°
            const frameDelay = rotateDuration * 1000 / frameCount; // æ¯å¸§é—´éš”
            const canvasSize = 500; // GIFå°ºå¯¸ 500x500ï¼ˆ1:1ï¼‰

            loadingTip.style.display = 'block';
            exportBtn.disabled = true;
            exportBtn.style.opacity = '0.6';

            try {
                // åˆå§‹åŒ–ffmpeg
                const { createFFmpeg, fetchFile } = FFmpeg;
                const ffmpeg = createFFmpeg({ log: false });
                await ffmpeg.load();

                // è°ƒæ•´èˆå°ä¸º1:1å°ºå¯¸
                const originalStyle = {
                    width: captureStage.style.width,
                    height: captureStage.style.height,
                    position: captureStage.style.position,
                    top: captureStage.style.top,
                    left: captureStage.style.left
                };
                captureStage.style.width = `${canvasSize}px`;
                captureStage.style.height = `${canvasSize}px`;
                captureStage.style.position = 'fixed';
                captureStage.style.top = `${(window.innerHeight - canvasSize)/2}px`;
                captureStage.style.left = `${(window.innerWidth - canvasSize)/2}px`;

                // æ•è·æ¯ä¸€å¸§
                for (let i = 0; i < frameCount; i++) {
                    // ç­‰å¾…å¸§é—´éš”
                    await new Promise(resolve => setTimeout(resolve, frameDelay));
                    // æˆªå›¾
                    const canvas = await html2canvas(captureStage, {
                        width: canvasSize,
                        height: canvasSize,
                        scale: 1,
                        useCORS: true
                    });
                    const dataUrl = canvas.toDataURL('image/png');
                    const blob = await (await fetch(dataUrl)).blob();
                    const arrayBuffer = await blob.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);
                    // å†™å…¥ffmpeg
                    ffmpeg.FS('writeFile', `frame${i}.png`, uint8Array);
                }

                // æ¢å¤èˆå°æ ·å¼
                captureStage.style.width = originalStyle.width;
                captureStage.style.height = originalStyle.height;
                captureStage.style.position = originalStyle.position;
                captureStage.style.top = originalStyle.top;
                captureStage.style.left = originalStyle.left;

                // è½¬æ¢ä¸ºGIF
                await ffmpeg.run(
                    '-framerate', '10',
                    '-i', 'frame%d.png',
                    '-vf', 'scale=500:500:force_original_aspect_ratio=1,pad=500:500:(ow-iw)/2:(oh-ih)/2',
                    '-loop', '0',
                    '-y',
                    'output.gif'
                );

                // ä¸‹è½½GIF
                const data = ffmpeg.FS('readFile', 'output.gif');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'image/gif' }));
                const a = document.createElement('a');
                a.href = url;
                a.download = `é¸¡å…¬ç…²åˆ¶ä½œ_${Date.now()}.gif`;
                a.click();
                URL.revokeObjectURL(url);

                // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                for (let i = 0; i < frameCount; i++) {
                    ffmpeg.FS('unlink', `frame${i}.png`);
                }
                ffmpeg.FS('unlink', 'output.gif');

            } catch (error) {
                alert('GIFå¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                console.error(error);
            } finally {
                loadingTip.style.display = 'none';
                exportBtn.disabled = false;
                exportBtn.style.opacity = '1';
            }
        }

        // äº‹ä»¶ç»‘å®š
        generateBtn.addEventListener('click', () => {
            generateTextEffect(textInput.value.trim());
        });

        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                generateTextEffect(textInput.value.trim());
            }
        });

        exportBtn.addEventListener('click', exportToGif);

        // åˆå§‹åŒ–
        generateTextEffect(displayText.textContent);
    </script>
</body>
</html>
